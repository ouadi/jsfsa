/*! jsfsa - v0.3.3 - 2014-05-24 Copyright (c) 2014 Camille Reynders (http://www.creynders.be/); Licensed MIT */!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):jsfsa=a()}(function(){"use strict";var a=function(){this._listeners={}};a.prototype.addListener=function(a,b){return this._listeners.hasOwnProperty(a)||(this._listeners[a]=[]),this._listeners[a].push(b),this},a.prototype.addListeners=function(a,b){if("function"==typeof b)return this.addListener(a,b);var c;return c=this._listeners.hasOwnProperty(a)?this._listeners[a]:[],this._listeners[a]=c.concat(b),this},a.prototype.hasListener=function(a,b){if(this._listeners.hasOwnProperty(a)){var c=this._listeners[a].indexOf(b);return c>=0}return!1},a.prototype.removeListener=function(a,b){if(this._listeners.hasOwnProperty(a)){var c=this._listeners[a].indexOf(b);c>=0&&this._listeners[a].splice(c,1)}return this},a.prototype.dispatch=function(a){var b=a.type,c=!0;if(this._listeners.hasOwnProperty(b))for(var d=Array.prototype.slice.call(arguments),e=0,f=this._listeners[b].length;f>e;e++){var g=this._listeners[b][e];c=g.apply(this,d)&&c}return c};var b=function(){};b.prototype=a.prototype;var c=function(a,b,c,d){this.fqn="jsfsa.StateEvent",this.type=a,this.from=b,this.to=c,this.transition=d};c.ENTERED="entered",c.EXITED="exited",c.ENTRY_DENIED="entryDenied",c.EXIT_DENIED="exitDenied",c.TRANSITION_DENIED="transitionDenied",c.CHANGED="changed",c.prototype.clone=function(){var a=new c(this.type,this.from,this.to,this.transition);return a},c.prototype._setType=function(a){return this.type=a,this};var d=function(){};d.ENTRY="entry",d.EXIT="exit";var e=function(b,c){a.call(this),this.fqn="jsfsa.State",this.name="",this.parent=void 0,this.isInitial=!1,this._guardian=void 0,this._transitions={},this._parseName(b),this.parseData(c)};e.prototype=new b,e.prototype.constructor=e,e._configMembers=["isInitial","guards","listeners","parent","transitions"],e.prototype.addTransition=function(a,b){return this._transitions[a]=b,this},e.prototype.removeTransition=function(a){return delete this._transitions[a],this},e.prototype.getTransition=function(a){return this._transitions[a]},e.prototype.hasTransition=function(a){return this._transitions.hasOwnProperty(a)},e.prototype.addGuard=function(a,b){return this._getGuardian().addListener(a,b),this},e.prototype.addGuards=function(a,b){return this._getGuardian().addListeners(a,b),this},e.prototype.hasGuard=function(a,b){return this._guardian&&this._guardian.hasListener(a,b)},e.prototype.removeGuard=function(a,b){return this._guardian&&this._guardian.removeListener(a,b),this},e.prototype.parseData=function(a){if(a){a.isInitial&&(this.isInitial=!0),a.guards&&(a.guards[d.ENTRY]&&this.addGuards(d.ENTRY,a.guards[d.ENTRY]),a.guards[d.EXIT]&&this.addGuards(d.EXIT,a.guards[d.EXIT]));for(var b in a.listeners)a.listeners.hasOwnProperty(b)&&this.addListeners(b,a.listeners[b]);a.parent&&(this.parent=a.parent),a.transitions&&this._addTransitions(a.transitions),this._addTransitions(a,e._configMembers)}},e.prototype.destroy=function(){this._guardian=void 0,this._transitions=void 0,this._listeners=void 0,this.name=void 0},e.prototype._getGuardian=function(){return void 0===this._guardian&&(this._guardian=new a),this._guardian},e.prototype._parseName=function(a){var b=a.lastIndexOf("/");b>=0&&(this.parent=a.substring(0,b)),this.name=a},e.prototype._executeGuards=function(a){var b=!0;if(this._guardian&&(b=this._guardian.dispatch.apply(this._guardian,a),!b)){a=a.slice(0);var c=a[0].clone();c.type+="Denied",a[0]=c,this.dispatch.apply(this,a)}return b},e.prototype._addTransitions=function(a,b){for(var c in a)if(a.hasOwnProperty(c)){if(b&&b.indexOf(c)>=0)continue;this.addTransition(c,a[c])}},e.prototype._dispatchArgs=function(a){this.dispatch.apply(this,a)};var f=function(a){this.state=a,this.parent=void 0,this.children=void 0,this.initialChild=void 0};f.prototype={addChild:function(a){this.children||(this.children={}),a.parent=this,a.state.isInitial&&(this.initialChild=a),this.children[a.state.name]=a},removeChild:function(a){this.initialChild===a&&(this.initialChild=void 0),delete this.children[a.state.name]},destroy:function(){for(var a in this.children)this.children.hasOwnProperty(a)&&this.children[a].destroy();this.state=void 0,this.parent=void 0,this.children=void 0},getInitialBranch:function(){for(var a=[],b=this.initialChild;b;)a.push(b),b=b.initialChild;return a}};var g=function(a,b,c,d){this.payload=a,this.from=c,this.to=d,this.transition=b};g.prototype={createEvent:function(a){return new c(a,this.from,this.to,this.transition)},createArgsArray:function(a){var b=this.payload.slice(0);return b.unshift(this.createEvent(a)),b}};var h=function(b,c){a.call(this),this.fqn="jsfsa.Automaton",this.name=c||"",this._nodes={},this._rootNode=new f(new e("root")),this._currentBranch=[this._rootNode],this._internalState="ready",this._queue=[],this._newBranch=void 0,b&&this.parse(b)};return h.prototype=new b,h.prototype.constructor=h,h.prototype.isTransitioning=function(){return"ready"!==this._internalState},h.prototype.getRootState=function(){return this._rootNode.state},h.prototype.getCurrentState=function(){return this._currentBranch[this._currentBranch.length-1].state},h.prototype.getCurrentBranch=function(){for(var a=this._currentBranch,b=[],c=1;c<a.length;c++){var d=a[c];b.push(d.state)}return b},h.prototype.isInCurrentBranch=function(a){var b=this._nodes[a];return b?this._currentBranch.indexOf(b)>-1:!1},h.prototype.createState=function(a,b){var c=new e(a,b);return this.addState(c),this},h.prototype.addState=function(a){if(!this.hasState(a.name)){var b=new f(a),c=a.parent?this._nodes[a.parent]:this._rootNode;c.addChild(b),a.isInitial&&c.state===this.getCurrentState()&&this._currentBranch.push(b),this._nodes[a.name]=b}return this},h.prototype.hasState=function(a){return this._nodes.hasOwnProperty(a)},h.prototype.getState=function(a){return this.hasState(a)?this._nodes[a].state:void 0},h.prototype.removeState=function(a){if(this.hasState(a)){var b=this._nodes[a],c=b.parent;c.removeChild(b);var d=this._currentBranch.indexOf(b);d>=0&&this._currentBranch.splice(d,this._currentBranch.length-d),b.destroy(),delete this._nodes[a]}return this},h.prototype.doTransition=function(a){if("ready"===this._internalState){var b;arguments.length>1?(b=Array.prototype.slice.call(arguments),b.shift()):b=[],this._newBranch=this._currentBranch;var d=new g(b,a,this.getCurrentState().name),e=this._hasTransitionInCurrentBranch(a);void 0===e?this._finishTransition(d.createArgsArray(c.TRANSITION_DENIED)):this._attemptTransition(e,d)}return this},h.prototype.parse=function(a){for(var b in a)a.hasOwnProperty(b)&&this.createState(b,a[b]);return this},h.prototype.proceed=function(){if(("transitioning"===this._internalState||"paused"===this._internalState)&&this._queue.length>0){this._internalState="transitioning";var a=this._queue.shift(),b=a.obj.state;b[a.method].call(b,a.args),"paused"!==this._internalState&&this.proceed()}return this},h.prototype.pause=function(){return"transitioning"===this._internalState&&(this._internalState="paused"),this},h.prototype.destroy=function(){this._rootNode.destroy(),this._rootNode=void 0,this._nodes=void 0,this._currentBranch=void 0},h.prototype._hasTransitionInCurrentBranch=function(a){for(var b,c=!1,d=this._currentBranch.length-1,e=0;d>=e;d--)if(b=this._currentBranch[d].state,b.hasTransition(a)){c=!0;break}return c?b:void 0},h.prototype._attemptTransition=function(a,b){var d,e=a.getTransition(b.transition);if("function"==typeof e){var f=b.createArgsArray();d=e.apply(this,f)}else d=e;var g=null;if(d&&(g=this._nodes[d]),g){b.to=g.state.name;var h=g.getInitialBranch();this._newBranch=this._getBranchFromRoot(g).concat(h);var i=this._getShortestRoute(this._currentBranch,this._newBranch);this._doExitGuardPhase(i,b)}else this._finishTransition(b.createArgsArray(c.TRANSITION_DENIED))},h.prototype._getBranchFromRoot=function(a){for(var b=[];a;)b.unshift(a),a=a.parent;return b},h.prototype._getShortestRoute=function(a,b){var c,d=Math.min(a.length,b.length);for(c=0;d>c&&a[c]===b[c];c++);var e=a.slice(c).reverse(),f=b.slice(c);return{up:e,down:f}},h.prototype._doExitGuardPhase=function(a,b){this._internalState="guarding";var e=this._executeGuards(a.up,b.createArgsArray(d.EXIT));return e?e=this._doEntryGuardPhase(a,b):(this._newBranch=void 0,this._finishTransition(b.createArgsArray(c.EXIT_DENIED))),e},h.prototype._doEntryGuardPhase=function(a,b){var e=this._executeGuards(a.down,b.createArgsArray(d.ENTRY));return e?this._startTransition(a,b):(this._newBranch=void 0,this._finishTransition(b.createArgsArray(c.ENTRY_DENIED))),e},h.prototype._executeGuards=function(a,b){for(var c=!0,d=0,e=a.length;e>d;d++){var f=a[d].state;c=f._executeGuards(b)&&c}return c},h.prototype._startTransition=function(a,b){this._internalState="transitioning",this._currentBranch=void 0;var d=[{state:this}],e=b.createArgsArray(c.EXITED);this._queue=[],this._addToQueue(a.up,"_dispatchArgs",e),this._addToQueue(d,"_dispatchArgs",e),e=b.createArgsArray(c.ENTERED),this._addToQueue(a.down,"_dispatchArgs",e),this._addToQueue(d,"_dispatchArgs",e),this._addToQueue(d,"_finishTransition",b.createArgsArray(c.CHANGED)),this.proceed()},h.prototype._addToQueue=function(a,b,c){for(var d=0,e=a.length;e>d;d++)this._queue.push({obj:a[d],args:c,method:b})},h.prototype._finishTransition=function(a){this._newBranch?this._currentBranch=this._newBranch:this._newBranch=void 0,this._internalState="ready",this._dispatchArgs(a)},h.prototype._dispatchArgs=e.prototype._dispatchArgs,{VERSION:"0.3.3",Action:d,StateEvent:c,State:e,Automaton:h}});